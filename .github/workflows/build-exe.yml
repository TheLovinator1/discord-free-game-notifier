name: Build Executable

on:
  push:
    tags:
      - "v*"

jobs:
  # MARK: Windows x86_64 Build
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: Create version info file
        run: |
          $version = (Get-Content pyproject.toml | Select-String 'version = "(.+)"').Matches.Groups[1].Value
          $versionParts = $version.Split('.')

          @"
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0),
              prodvers=($($versionParts[0]), $($versionParts[1]), $($versionParts[2]), 0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                  StringTable(
                    u'040904B0',
                    [StringStruct(u'CompanyName', u'TheLovinator'),
                    StringStruct(u'FileDescription', u'Discord Free Game Notifier - Get notified of free games'),
                    StringStruct(u'FileVersion', u'`$version'),
                    StringStruct(u'InternalName', u'discord-free-game-notifier'),
                    StringStruct(u'LegalCopyright', u'Joakim HellsÃ©n'),
                    StringStruct(u'OriginalFilename', u'discord-free-game-notifier.exe'),
                    StringStruct(u'ProductName', u'Discord Free Game Notifier'),
                    StringStruct(u'ProductVersion', u'`$version')])
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          "@ | Out-File -FilePath version_info.txt -Encoding UTF8
        shell: pwsh

      - name: Generate PyInstaller spec file
        run: |
          uv run pyi-makespec --onefile --name discord-free-game-notifier --console --version-file version_info.txt src/discord_free_game_notifier/main.py

      - name: Build executable with PyInstaller
        run: |
          uv run pyinstaller discord-free-game-notifier.spec

      - name: Generate SHA256 checksum
        run: |
          $hash = (Get-FileHash -Path dist/discord-free-game-notifier.exe -Algorithm SHA256).Hash
          "$hash  discord-free-game-notifier.exe" | Out-File -FilePath dist/discord-free-game-notifier.exe.sha256 -Encoding ASCII
          Write-Host "SHA256: $hash"
        shell: pwsh

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/discord-free-game-notifier.exe"

      - name: Upload Windows executable
        uses: actions/upload-artifact@v5
        with:
          name: discord-free-game-notifier-windows
          path: |
            dist/discord-free-game-notifier.exe
            dist/discord-free-game-notifier.exe.sha256
          retention-days: 90

      - name: Extract version from pyproject.toml
        id: version
        run: |
          $version = (Get-Content pyproject.toml | Select-String 'version = "(.+)"').Matches.Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          body: |
            ## Docker Images

            ```bash
            docker pull ghcr.io/thelovinator1/discord-free-game-notifier:${{ steps.version.outputs.version }}
            ```

            Available tags:
            - `ghcr.io/thelovinator1/discord-free-game-notifier:${{ steps.version.outputs.version }}`
            - `ghcr.io/thelovinator1/discord-free-game-notifier:latest`
          files: |
            dist/discord-free-game-notifier.exe
            dist/discord-free-game-notifier.exe.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # MARK: Linux x86_64 Build
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | cut -d '"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate PyInstaller spec file
        run: |
          uv run pyi-makespec --onefile --name discord-free-game-notifier --console src/discord_free_game_notifier/main.py

      - name: Build executable with PyInstaller
        run: |
          uv run pyinstaller discord-free-game-notifier.spec

      - name: Generate SHA256 checksum
        run: |
          cd dist
          sha256sum discord-free-game-notifier > discord-free-game-notifier.sha256
          cat discord-free-game-notifier.sha256

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/discord-free-game-notifier"

      - name: Upload Linux executable
        uses: actions/upload-artifact@v5
        with:
          name: discord-free-game-notifier-linux
          path: |
            dist/discord-free-game-notifier
            dist/discord-free-game-notifier.sha256
          retention-days: 90

      - name: Rename for release
        run: |
          mv dist/discord-free-game-notifier dist/discord-free-game-notifier-linux-x86_64
          mv dist/discord-free-game-notifier.sha256 dist/discord-free-game-notifier-linux-x86_64.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/discord-free-game-notifier-linux-x86_64
            dist/discord-free-game-notifier-linux-x86_64.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # MARK: macOS x86_64 Build
  build-macos-intel:
    runs-on: macos-15-intel
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | cut -d '"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate PyInstaller spec file
        run: |
          uv run pyi-makespec --onefile --name discord-free-game-notifier --console --osx-bundle-identifier space.lovinator.discord-free-game-notifier src/discord_free_game_notifier/main.py

      - name: Build executable with PyInstaller
        run: |
          uv run pyinstaller discord-free-game-notifier.spec

      - name: Generate SHA256 checksum
        run: |
          cd dist
          shasum -a 256 discord-free-game-notifier > discord-free-game-notifier.sha256
          cat discord-free-game-notifier.sha256

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/discord-free-game-notifier"

      - name: Upload macOS executable
        uses: actions/upload-artifact@v5
        with:
          name: discord-free-game-notifier-macos
          path: |
            dist/discord-free-game-notifier
            dist/discord-free-game-notifier.sha256
          retention-days: 90

      - name: Rename for release
        run: |
          mv dist/discord-free-game-notifier dist/discord-free-game-notifier-macos-x86_64
          mv dist/discord-free-game-notifier.sha256 dist/discord-free-game-notifier-macos-x86_64.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/discord-free-game-notifier-macos-x86_64
            dist/discord-free-game-notifier-macos-x86_64.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # MARK: macOS ARM64 Build
  build-macos-arm64:
    runs-on: macos-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | cut -d '"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate PyInstaller spec file
        run: |
          uv run pyi-makespec --onefile --name discord-free-game-notifier-arm64 --console --osx-bundle-identifier space.lovinator.discord-free-game-notifier src/discord_free_game_notifier/main.py

      - name: Build executable with PyInstaller
        run: |
          uv run pyinstaller discord-free-game-notifier-arm64.spec

      - name: Rename executable
        run: |
          mv dist/discord-free-game-notifier-arm64 dist/discord-free-game-notifier

      - name: Generate SHA256 checksum
        run: |
          cd dist
          shasum -a 256 discord-free-game-notifier > discord-free-game-notifier.sha256
          cat discord-free-game-notifier.sha256

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/discord-free-game-notifier"

      - name: Upload macOS ARM64 executable
        uses: actions/upload-artifact@v5
        with:
          name: discord-free-game-notifier-macos-arm64
          path: |
            dist/discord-free-game-notifier
            dist/discord-free-game-notifier.sha256
          retention-days: 90

      - name: Rename for release
        run: |
          mv dist/discord-free-game-notifier dist/discord-free-game-notifier-macos-aarch64
          mv dist/discord-free-game-notifier.sha256 dist/discord-free-game-notifier-macos-aarch64.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/discord-free-game-notifier-macos-aarch64
            dist/discord-free-game-notifier-macos-aarch64.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # MARK: Linux ARM64 Build
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | cut -d '"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate PyInstaller spec file
        run: |
          uv run pyi-makespec --onefile --name discord-free-game-notifier-arm64 --console src/discord_free_game_notifier/main.py

      - name: Build executable with PyInstaller
        run: |
          uv run pyinstaller discord-free-game-notifier-arm64.spec

      - name: Rename executable
        run: |
          mv dist/discord-free-game-notifier-arm64 dist/discord-free-game-notifier

      - name: Generate SHA256 checksum
        run: |
          cd dist
          sha256sum discord-free-game-notifier > discord-free-game-notifier.sha256
          cat discord-free-game-notifier.sha256

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/discord-free-game-notifier"

      - name: Upload Linux ARM64 executable
        uses: actions/upload-artifact@v5
        with:
          name: discord-free-game-notifier-linux-arm64
          path: |
            dist/discord-free-game-notifier
            dist/discord-free-game-notifier.sha256
          retention-days: 90

      - name: Rename for release
        run: |
          mv dist/discord-free-game-notifier dist/discord-free-game-notifier-linux-aarch64
          mv dist/discord-free-game-notifier.sha256 dist/discord-free-game-notifier-linux-aarch64.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/discord-free-game-notifier-linux-aarch64
            dist/discord-free-game-notifier-linux-aarch64.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
